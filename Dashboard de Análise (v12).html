<!DOCTYPE html>
<!-- saved from url=(0038)http://localhost/graficos/graficos.php -->
<html lang="pt-br"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Análise (v12)</title>
    <script src="./Dashboard de Análise (v12)_files/chart.js.download"></script>
    <script src="./Dashboard de Análise (v12)_files/chartjs-plugin-datalabels.min.js.download"></script>
    
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f4f7f6; }
        h1, h2 { text-align: center; color: #333; }
        
        /* (v10) Estilo dos KPIs */
        .kpi-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            width: 90%; max-width: 1800px; margin: 20px auto;
        }
        .kpi-box {
            background-color: #ffffff;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            padding: 20px;
            text-align: center;
        }
        .kpi-title {
            font-size: 1rem;
            font-weight: 600;
            color: #555;
            margin: 0;
        }
        .kpi-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: #1a73e8;
            margin: 10px 0 0 0;
        }
        
        .filter-container {
            display: flex; flex-wrap: wrap; justify-content: center; gap: 15px;
            width: 90%; max-width: 1800px; margin: 20px auto; padding: 15px;
            background-color: #ffffff; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }
        .filter-group { display: flex; flex-direction: column; }
        .filter-group label { font-size: 0.8rem; font-weight: 600; color: #555; margin-bottom: 5px; }
        .filter-group select {
            padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px;
            background-color: #fafafa; font-size: 0.9rem; min-width: 200px;
        }
        
        .dashboard-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            width: 90%; max-width: 1800px; margin: 20px auto;
        }
        .chart-box {
            background-color: #ffffff; border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05); padding: 20px;
            min-height: 400px;
        }
        .chart-box-horizontal {
            min-height: 450px;
        }
        
        /* (v10) Estilo da Tabela */
        .table-box {
            width: 90%; max-width: 1800px; margin: 20px auto;
            background-color: #ffffff; border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05); padding: 20px;
            overflow-x: auto;
        }
        #data-table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        #data-table th, #data-table td {
            border: 1px solid #ddd; padding: 8px 12px; text-align: left;
            font-size: 0.9rem; white-space: nowrap;
        }
        #data-table th { background-color: #f4f7f6; font-weight: 600; position: sticky; top: 0; }
        #data-table td:first-child { font-weight: bold; background-color: #f9f9f9; }
        #data-table td:not(:first-child) { text-align: right; }
    </style>
</head>
<body>

    <h1>Dashboard de Despesas</h1>

    <div class="kpi-container">
        <div class="kpi-box">
            <h2 class="kpi-title">Valor Total (Filtrado)</h2>
            <p class="kpi-value" id="kpi-total-valor">R$&nbsp;2.155.176</p>
        </div>
        <div class="kpi-box" id="kpi-empresa-construcao" style="display: block;">
            <h2 class="kpi-title">Total Construção</h2>
            <p class="kpi-value" id="kpi-valor-construcao">R$&nbsp;2.095.388</p>
        </div>
        <div class="kpi-box" id="kpi-empresa-locacao" style="display: block;">
            <h2 class="kpi-title">Total Locação</h2>
            <p class="kpi-value" id="kpi-valor-locacao">R$&nbsp;59.788</p>
        </div>
    </div>

    <div class="filter-container">
        <div class="filter-group">
            <label for="filter-empresa">Filtrar por Empresa</label>
            <select id="filter-empresa">
                <option value="todos">Todas as Empresas</option>
                                    <option value="CONSTRUÇÃO">CONSTRUÇÃO</option>
                                    <option value="LOCAÇÃO">LOCAÇÃO</option>
                            </select>
        </div>
        <div class="filter-group">
            <label for="filter-mes">Filtrar por Mês</label>
            <select id="filter-mes">
                <option value="todos">Todos os Meses</option>
                                    <option value="NOVEMBRO">NOVEMBRO</option>
                                    <option value="DEZEMBRO">DEZEMBRO</option>
                            </select>
        </div>
         <div class="filter-group">
            <label for="filter-local">Filtrar por Local</label>
            <select id="filter-local">
                <option value="todos">Todos os Locais</option>
                                    <option value="MA">MA</option>
                                    <option value="MG">MG</option>
                                    <option value="MS">MS</option>
                                    <option value="GERAL">GERAL</option>
                                    <option value="LOC">LOC</option>
                                    <option value="MT">MT</option>
                            </select>
        </div>
        <div class="filter-group">
            <label for="filter-observacoes">Filtrar por Observação</label>
            <select id="filter-observacoes">
                <option value="todos">Todas as Observações</option>
                                    <option value="PARCELA 13° SALÁRIO">PARCELA 13° SALÁRIO</option>
                                    <option value="13° SALÁRIO">13° SALÁRIO</option>
                                    <option value="FOLHA DE PAGAMENTO">FOLHA DE PAGAMENTO</option>
                                    <option value="FOLHA DE PAGAMENTO - RAFAEL">FOLHA DE PAGAMENTO - RAFAEL</option>
                                    <option value="FLASH">FLASH</option>
                                    <option value="VIAGEM">VIAGEM</option>
                                    <option value="PESSOA JURIDICA">PESSOA JURIDICA</option>
                            </select>
        </div>
    </div>

    <div class="dashboard-container">
        <div class="chart-box">
            <canvas id="chartEmpresa" width="550" height="400" style="display: block; box-sizing: border-box; height: 400px; width: 550.8px;"></canvas>
        </div>
        <div class="chart-box">
            <canvas id="chartLocal" width="550" height="400" style="display: block; box-sizing: border-box; height: 400px; width: 550.8px;"></canvas>
        </div>
        <div class="chart-box">
            <canvas id="chartMes" width="550" height="450" style="display: block; box-sizing: border-box; height: 450px; width: 550.8px;"></canvas>
        </div>
        <div class="chart-box chart-box-horizontal">
            <canvas id="chartObservacoes" width="550" height="450" style="display: block; box-sizing: border-box; height: 450px; width: 550.8px;"></canvas>
        </div>
        <div class="chart-box">
            <canvas id="chartMesStacked" width="550" height="400" style="display: block; box-sizing: border-box; height: 400px; width: 550.8px;"></canvas>
        </div>
        <div class="chart-box">
            <canvas id="chartLocalStacked" width="550" height="400" style="display: block; box-sizing: border-box; height: 400px; width: 550.8px;"></canvas>
        </div>
        <div class="chart-box chart-box-horizontal">
            <canvas id="chartObservacoesComparativo" width="550" height="450" style="display: block; box-sizing: border-box; height: 450px; width: 550.8px;"></canvas>
        </div>
    </div>
    
    <div class="table-box">
        <h2>Tabela de Resumo (Observação vs. Local)</h2>
        <div id="data-table-container"><table id="data-table"><thead><tr><th>Observação / Local</th><th>MA</th><th>MG</th><th>MS</th><th>GERAL</th><th>LOC</th><th>MT</th></tr></thead><tbody><tr><td>PARCELA 13° SALÁRIO</td><td>R$&nbsp;42.044</td><td>R$&nbsp;17.414</td><td>R$&nbsp;123.245</td><td>R$&nbsp;0</td><td>R$&nbsp;11.569</td><td>R$&nbsp;0</td></tr><tr><td>13° SALÁRIO</td><td>R$&nbsp;31.858</td><td>R$&nbsp;11.850</td><td>R$&nbsp;86.427</td><td>R$&nbsp;0</td><td>R$&nbsp;8.912</td><td>R$&nbsp;0</td></tr><tr><td>FOLHA DE PAGAMENTO</td><td>R$&nbsp;161.040</td><td>R$&nbsp;71.101</td><td>R$&nbsp;683.331</td><td>R$&nbsp;0</td><td>R$&nbsp;39.308</td><td>R$&nbsp;0</td></tr><tr><td>FOLHA DE PAGAMENTO - RAFAEL</td><td>R$&nbsp;0</td><td>R$&nbsp;0</td><td>R$&nbsp;0</td><td>R$&nbsp;46.000</td><td>R$&nbsp;0</td><td>R$&nbsp;0</td></tr><tr><td>FLASH</td><td>R$&nbsp;24.990</td><td>R$&nbsp;28.100</td><td>R$&nbsp;424.764</td><td>R$&nbsp;0</td><td>R$&nbsp;4.600</td><td>R$&nbsp;0</td></tr><tr><td>VIAGEM</td><td>R$&nbsp;0</td><td>R$&nbsp;0</td><td>R$&nbsp;10.420</td><td>R$&nbsp;0</td><td>R$&nbsp;0</td><td>R$&nbsp;59.694</td></tr><tr><td>PESSOA JURIDICA</td><td>R$&nbsp;0</td><td>R$&nbsp;0</td><td>R$&nbsp;0</td><td>R$&nbsp;268.509</td><td>R$&nbsp;0</td><td>R$&nbsp;0</td></tr></tbody></table></div>
    </div>


    <script>
        // Registra o plugin de data labels
        Chart.register(ChartDataLabels);

        // --- Formatadores de Números ---
        const numberFormatter = new Intl.NumberFormat('pt-BR', {
            style: 'currency', currency: 'BRL',
            minimumFractionDigits: 0, maximumFractionDigits: 0
        });
        const compactFormatter = new Intl.NumberFormat('pt-BR', {
            notation: 'compact', compactDisplay: 'short'
        });
        
        // Ordem correta dos meses 
        const monthOrder = {
            'JANEIRO': 1, 'FEVEREIRO': 2, 'MARÇO': 3, 'ABRIL': 4, 'MAIO': 5, 'JUNHO': 6,
            'JULHO': 7, 'AGOSTO': 8, 'SETEMBRO': 9, 'OUTUBRO': 10, 'NOVEMBRO': 11, 'DEZEMBRO': 12
        };
        
        // --- Armazena os Dados Brutos do PHP ---
        const rawData = [{"empresa":"CONSTRU\u00c7\u00c3O","mes":"NOVEMBRO","observacoes":"PARCELA 13\u00b0 SAL\u00c1RIO","local":"MA","valor":42044.02},{"empresa":"CONSTRU\u00c7\u00c3O","mes":"NOVEMBRO","observacoes":"PARCELA 13\u00b0 SAL\u00c1RIO","local":"MG","valor":17413.8},{"empresa":"CONSTRU\u00c7\u00c3O","mes":"NOVEMBRO","observacoes":"PARCELA 13\u00b0 SAL\u00c1RIO","local":"MS","valor":123244.88},{"empresa":"CONSTRU\u00c7\u00c3O","mes":"DEZEMBRO","observacoes":"13\u00b0 SAL\u00c1RIO","local":"MA","valor":31857.91},{"empresa":"CONSTRU\u00c7\u00c3O","mes":"DEZEMBRO","observacoes":"13\u00b0 SAL\u00c1RIO","local":"MG","valor":11850.12},{"empresa":"CONSTRU\u00c7\u00c3O","mes":"DEZEMBRO","observacoes":"13\u00b0 SAL\u00c1RIO","local":"MS","valor":86426.93},{"empresa":"CONSTRU\u00c7\u00c3O","mes":"NOVEMBRO","observacoes":"FOLHA DE PAGAMENTO","local":"MA","valor":79012.09},{"empresa":"CONSTRU\u00c7\u00c3O","mes":"NOVEMBRO","observacoes":"FOLHA DE PAGAMENTO","local":"MG","valor":35526.55},{"empresa":"CONSTRU\u00c7\u00c3O","mes":"NOVEMBRO","observacoes":"FOLHA DE PAGAMENTO","local":"MS","valor":341506.28},{"empresa":"CONSTRU\u00c7\u00c3O","mes":"NOVEMBRO","observacoes":"FOLHA DE PAGAMENTO - RAFAEL","local":"GERAL","valor":23000},{"empresa":"CONSTRU\u00c7\u00c3O","mes":"DEZEMBRO","observacoes":"FOLHA DE PAGAMENTO","local":"MA","valor":82027.82},{"empresa":"CONSTRU\u00c7\u00c3O","mes":"DEZEMBRO","observacoes":"FOLHA DE PAGAMENTO","local":"MG","valor":35574.74},{"empresa":"CONSTRU\u00c7\u00c3O","mes":"DEZEMBRO","observacoes":"FOLHA DE PAGAMENTO","local":"MS","valor":341824.85},{"empresa":"CONSTRU\u00c7\u00c3O","mes":"DEZEMBRO","observacoes":"FOLHA DE PAGAMENTO - RAFAEL","local":"GERAL","valor":23000},{"empresa":"LOCA\u00c7\u00c3O","mes":"NOVEMBRO","observacoes":"PARCELA 13\u00b0 SAL\u00c1RIO","local":"LOC","valor":11569.12},{"empresa":"LOCA\u00c7\u00c3O","mes":"DEZEMBRO","observacoes":"13\u00b0 SAL\u00c1RIO","local":"LOC","valor":8911.69},{"empresa":"LOCA\u00c7\u00c3O","mes":"NOVEMBRO","observacoes":"FOLHA DE PAGAMENTO","local":"LOC","valor":19375.28},{"empresa":"LOCA\u00c7\u00c3O","mes":"DEZEMBRO","observacoes":"FOLHA DE PAGAMENTO","local":"LOC","valor":19932.3},{"empresa":"CONSTRU\u00c7\u00c3O","mes":"NOVEMBRO","observacoes":"FLASH","local":"MA","valor":11345},{"empresa":"CONSTRU\u00c7\u00c3O","mes":"NOVEMBRO","observacoes":"FLASH","local":"MG","valor":14050},{"empresa":"CONSTRU\u00c7\u00c3O","mes":"NOVEMBRO","observacoes":"FLASH","local":"MS","valor":164394.65},{"empresa":"CONSTRU\u00c7\u00c3O","mes":"NOVEMBRO","observacoes":"FLASH","local":"LOC","valor":2300},{"empresa":"CONSTRU\u00c7\u00c3O","mes":"DEZEMBRO","observacoes":"FLASH","local":"MA","valor":13645},{"empresa":"CONSTRU\u00c7\u00c3O","mes":"DEZEMBRO","observacoes":"FLASH","local":"MG","valor":14050},{"empresa":"CONSTRU\u00c7\u00c3O","mes":"DEZEMBRO","observacoes":"FLASH","local":"MS","valor":260369.65},{"empresa":"CONSTRU\u00c7\u00c3O","mes":"DEZEMBRO","observacoes":"FLASH","local":"LOC","valor":2300},{"empresa":"CONSTRU\u00c7\u00c3O","mes":"DEZEMBRO","observacoes":"VIAGEM","local":"MT","valor":59693.94},{"empresa":"CONSTRU\u00c7\u00c3O","mes":"DEZEMBRO","observacoes":"VIAGEM","local":"MS","valor":10420.1},{"empresa":"CONSTRU\u00c7\u00c3O","mes":"NOVEMBRO","observacoes":"PESSOA JURIDICA","local":"GERAL","valor":134254.6},{"empresa":"CONSTRU\u00c7\u00c3O","mes":"DEZEMBRO","observacoes":"PESSOA JURIDICA","local":"GERAL","valor":134254.6}];
        
        // --- (v10) Referências dos Filtros e KPIs ---
        const filterEmpresa = document.getElementById('filter-empresa');
        const filterMes = document.getElementById('filter-mes');
        const filterLocal = document.getElementById('filter-local');
        const filterObservacoes = document.getElementById('filter-observacoes');
        
        const kpiTotalValor = document.getElementById('kpi-total-valor');
        const kpiValorConstrucao = document.getElementById('kpi-valor-construcao');
        const kpiValorLocacao = document.getElementById('kpi-valor-locacao');
        const kpiBoxConstrucao = document.getElementById('kpi-empresa-construcao');
        const kpiBoxLocacao = document.getElementById('kpi-empresa-locacao');
        
        // --- (v12) Variáveis globais dos Gráficos ---
        let chartEmpresa, chartMes, chartLocal, chartObservacoes, chartMesStacked, chartLocalStacked, chartObservacoesComparativo;
        
        // --- (v10) Gera Cores para os gráficos empilhados ---
        const observacoesColors = {};
                    observacoesColors['PARCELA 13° SALÁRIO'] = 'rgba(5, 114, 77, 0.7)';
                    observacoesColors['13° SALÁRIO'] = 'rgba(79, 139, 244, 0.7)';
                    observacoesColors['FOLHA DE PAGAMENTO'] = 'rgba(69, 127, 161, 0.7)';
                    observacoesColors['FOLHA DE PAGAMENTO - RAFAEL'] = 'rgba(105, 181, 129, 0.7)';
                    observacoesColors['FLASH'] = 'rgba(172, 27, 88, 0.7)';
                    observacoesColors['VIAGEM'] = 'rgba(230, 56, 57, 0.7)';
                    observacoesColors['PESSOA JURIDICA'] = 'rgba(82, 30, 146, 0.7)';
                
        const empresaColors = {};
                    empresaColors['CONSTRUÇÃO'] = 'rgba(229, 78, 246, 0.7)';
                    empresaColors['LOCAÇÃO'] = 'rgba(183, 126, 1, 0.7)';
                
        // --- (v11) Gera Cores para os meses ---
        const mesColors = {};
                    mesColors['NOVEMBRO'] = 'rgba(112, 74, 37, 0.7)';
                    mesColors['DEZEMBRO'] = 'rgba(135, 135, 65, 0.7)';
        
        
        /**
         * (v11) Função principal de cálculo
         */
        function calculateChartData(data) {
            let aggEmpresa = {};
            let aggMes = {};
            let aggLocal = {};
            let aggObservacoes = {};
            let aggMesEmpresa = {}; // Para chart 5
            let aggLocalObservacoes = {}; // Para chart 6 e Tabela
            let aggObservacoesMes = {}; // Para chart 7
            let totalValor = 0;
            
            let uniqueMeses = new Set();
            let uniqueEmpresas = new Set();
            let uniqueLocais = new Set();
            let uniqueObservacoes = new Set();

            data.forEach(row => {
                totalValor += row.valor;

                // Agregadores Simples
                if (!aggEmpresa[row.empresa]) aggEmpresa[row.empresa] = 0;
                aggEmpresa[row.empresa] += row.valor;

                if (!aggMes[row.mes]) aggMes[row.mes] = 0;
                aggMes[row.mes] += row.valor;

                if (!aggLocal[row.local]) aggLocal[row.local] = 0;
                aggLocal[row.local] += row.valor;
                
                if (!aggObservacoes[row.observacoes]) aggObservacoes[row.observacoes] = 0;
                aggObservacoes[row.observacoes] += row.valor;
                
                // Agregadores Empilhados (Chart 5)
                if (!aggMesEmpresa[row.mes]) aggMesEmpresa[row.mes] = {};
                if (!aggMesEmpresa[row.mes][row.empresa]) aggMesEmpresa[row.mes][row.empresa] = 0;
                aggMesEmpresa[row.mes][row.empresa] += row.valor;
                
                // Agregadores Empilhados (Chart 6 e Tabela)
                if (!aggLocalObservacoes[row.local]) aggLocalObservacoes[row.local] = {};
                if (!aggLocalObservacoes[row.local][row.observacoes]) aggLocalObservacoes[row.local][row.observacoes] = 0;
                aggLocalObservacoes[row.local][row.observacoes] += row.valor;
                
                // (v11): Agregador para Chart 7
                if (!aggObservacoesMes[row.observacoes]) aggObservacoesMes[row.observacoes] = {};
                if (!aggObservacoesMes[row.observacoes][row.mes]) aggObservacoesMes[row.observacoes][row.mes] = 0;
                aggObservacoesMes[row.observacoes][row.mes] += row.valor;

                // Guarda rótulos únicos
                uniqueMeses.add(row.mes);
                uniqueEmpresas.add(row.empresa);
                uniqueLocais.add(row.local);
                uniqueObservacoes.add(row.observacoes);
            });

            // --- Prepara Gráfico Empresa (Pizza) ---
            const chartEmpresaData = {
                labels: Object.keys(aggEmpresa),
                datasets: [{ label: 'Distribuição por Empresa', data: Object.values(aggEmpresa) }]
            };
            
            // --- Prepara Gráfico Mês (Barra Ordenada) ---
            let sortedMes = Object.entries(aggMes).sort((a, b) => (monthOrder[a[0]] || 0) - (monthOrder[b[0]] || 0));
            const chartMesData = {
                labels: sortedMes.map(item => item[0]),
                datasets: [{
                    label: 'Valor Total por Mês',
                    data: sortedMes.map(item => item[1]),
                    backgroundColor: 'rgba(255, 159, 64, 0.7)'
                }]
            };

            // --- Prepara Gráfico Local (Barra) ---
            const chartLocalData = {
                labels: Object.keys(aggLocal),
                datasets: [{
                    label: 'Valor Total por Local',
                    data: Object.values(aggLocal),
                    backgroundColor: 'rgba(54, 162, 235, 0.7)'
                }]
            };

            // --- Prepara Gráfico Observações (Barra Horizontal Ordenada) ---
            let sortedObservacoes = Object.entries(aggObservacoes).sort((a, b) => b[1] - a[1]);
            const chartObservacoesData = {
                labels: sortedObservacoes.map(item => item[0]),
                datasets: [{
                    label: 'Valor Total por Observação',
                    data: sortedObservacoes.map(item => item[1]),
                    backgroundColor: 'rgba(255, 99, 132, 0.7)'
                }]
            };
            
            // --- Prepara Gráfico Mês Empilhado por Empresa (Chart 5) ---
            const labelsMeses = Array.from(uniqueMeses).sort((a, b) => (monthOrder[a] || 0) - (monthOrder[b] || 0));
            const labelsEmpresas = Array.from(uniqueEmpresas);
            const datasets5 = labelsEmpresas.map(empresa => {
                const data = labelsMeses.map(mes => {
                    return aggMesEmpresa[mes] ? (aggMesEmpresa[mes][empresa] || 0) : 0;
                });
                return { label: empresa, data: data, backgroundColor: empresaColors[empresa] };
            });
            const chartMesStackedData = { labels: labelsMeses, datasets: datasets5 };

            // --- Prepara Gráfico Local Empilhado por Observação (Chart 6) ---
            const labelsLocais = Array.from(uniqueLocais);
            const labelsObservacoes = Array.from(uniqueObservacoes);
            const datasets6 = labelsObservacoes.map(obs => {
                const data = labelsLocais.map(local => {
                    return aggLocalObservacoes[local] ? (aggLocalObservacoes[local][obs] || 0) : 0;
                });
                return { label: obs, data: data, backgroundColor: observacoesColors[obs] };
            });
            const chartLocalStackedData = { labels: labelsLocais, datasets: datasets6 };
            
            // --- (v11): Prepara Gráfico Observações COMPARATIVO por Mês (Chart 7) ---
            const labelsObsSorted = sortedObservacoes.map(item => item[0]);
            const datasets7 = labelsMeses.map(mes => {
                const data = labelsObsSorted.map(obs => {
                    return aggObservacoesMes[obs] ? (aggObservacoesMes[obs][mes] || 0) : 0;
                });
                return {
                    label: mes,
                    data: data,
                    backgroundColor: mesColors[mes] || 'rgba(150, 150, 150, 0.7)'
                };
            });
            // (v12) Nome da variável mantido, mas o gráfico será configurado como AGRUPADO
            const chartObservacoesComparativoData = { labels: labelsObsSorted, datasets: datasets7 };


            return { 
                totalValor, aggEmpresa, // Para KPIs
                chartEmpresaData, chartMesData, chartLocalData, chartObservacoesData, // Gráficos simples
                chartMesStackedData, chartLocalStackedData, chartObservacoesComparativoData, // Gráficos complexos
                aggLocalObservacoes, labelsLocais, labelsObservacoes // Para Tabela
            };
        }
        
        /**
         * (v10) Função para atualizar os KPIs
         */
        function updateKPIs(total, aggEmpresa) {
            kpiTotalValor.textContent = numberFormatter.format(total);
            
            let valConstrucao = 0;
            let valLocacao = 0;
            
            for (const key in aggEmpresa) {
                if (key.toUpperCase().includes('CONSTRUÇÃO')) {
                    valConstrucao += aggEmpresa[key];
                }
                if (key.toUpperCase().includes('LOCAÇÃO')) {
                    valLocacao += aggEmpresa[key];
                }
            }

            kpiValorConstrucao.textContent = numberFormatter.format(valConstrucao);
            kpiValorLocacao.textContent = numberFormatter.format(valLocacao);
            
            kpiBoxConstrucao.style.display = (valConstrucao > 0 || total === 0) ? 'block' : 'none';
            kpiBoxLocacao.style.display = (valLocacao > 0 || total === 0) ? 'block' : 'none';
        }
        
        
        /**
         * (v10) Função para desenhar a tabela de resumo
         */
        function updateTable(aggData, labelsLinhas, labelsColunas) {
            const container = document.getElementById('data-table-container');
            let html = '<table id="data-table"><thead><tr><th>Observação / Local</th>';

            labelsColunas.forEach(col => { html += `<th>${col}</th>`; });
            html += '</tr></thead><tbody>';

            labelsLinhas.forEach(linha => {
                html += `<tr><td>${linha}</td>`;
                labelsColunas.forEach(col => {
                    const valor = (aggData[col] && aggData[col][linha]) ? aggData[col][linha] : 0;
                    html += `<td>${numberFormatter.format(valor)}</td>`;
                });
                html += '</tr>';
            });

            html += '</tbody></table>';
            container.innerHTML = html;
        }


        /**
         * (v12) Função chamada quando qualquer filtro muda.
         */
        function updateCharts() {
            // 1. Pega os valores dos filtros
            const selectedEmpresa = filterEmpresa.value;
            const selectedMes = filterMes.value;
            const selectedLocal = filterLocal.value;
            const selectedObservacoes = filterObservacoes.value;

            // 2. Filtra os dados brutos
            const filteredData = rawData.filter(row => {
                const passEmpresa = (selectedEmpresa === 'todos') || (row.empresa === selectedEmpresa);
                const passMes = (selectedMes === 'todos') || (row.mes === selectedMes);
                const passLocal = (selectedLocal === 'todos') || (row.local === selectedLocal);
                const passObservacoes = (selectedObservacoes === 'todos') || (row.observacoes === selectedObservacoes);
                return passEmpresa && passMes && passLocal && passObservacoes;
            });

            // 3. Calcula os novos dados de gráfico
            const newData = calculateChartData(filteredData);
            
            // 4. Atualiza os KPIs
            updateKPIs(newData.totalValor, newData.aggEmpresa);
            
            // 5. Atualiza os 7 gráficos
            chartEmpresa.data = newData.chartEmpresaData;
            chartEmpresa.update();
            
            chartMes.data = newData.chartMesData;
            chartMes.update();
            
            chartLocal.data = newData.chartLocalData;
            chartLocal.update();
            
            chartObservacoes.data = newData.chartObservacoesData;
            chartObservacoes.update();
            
            chartMesStacked.data = newData.chartMesStackedData;
            chartMesStacked.update();
            
            chartLocalStacked.data = newData.chartLocalStackedData;
            chartLocalStacked.update();
            
            chartObservacoesComparativo.data = newData.chartObservacoesComparativoData; // (v12)
            chartObservacoesComparativo.update(); // (v12)
            
            // 6. Atualiza a tabela
            updateTable(newData.aggLocalObservacoes, newData.labelsObservacoes, newData.labelsLocais);
        }
        
        /**
         * (v12) Função de inicialização
         */
        function init() {
            // Adiciona os event listeners
            filterEmpresa.addEventListener('change', updateCharts);
            filterMes.addEventListener('change', updateCharts);
            filterLocal.addEventListener('change', updateCharts);
            filterObservacoes.addEventListener('change', updateCharts);
            
            // Calcula os dados iniciais (com todos os dados)
            const initialData = calculateChartData(rawData);

            // --- Cria Gráfico 1: Empresa (Pizza) ---
            chartEmpresa = new Chart(document.getElementById('chartEmpresa'), {
                type: 'pie', data: initialData.chartEmpresaData,
                options: { responsive: true, maintainAspectRatio: false, plugins: {
                    title: { display: true, text: 'Visão por Empresa', font: { size: 16 } },
                    legend: { position: 'top' },
                    datalabels: {
                        formatter: (value, ctx) => {
                            const total = ctx.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                            if (total === 0) return '0%';
                            const percentage = (value / total * 100).toFixed(1);
                            return percentage + '%'; 
                        },
                        color: '#fff', font: { weight: 'bold' }
                    }
                }}
            });
            
            // --- Cria Gráfico 2: Local (Barra) ---
            chartLocal = new Chart(document.getElementById('chartLocal'), {
                type: 'bar', data: initialData.chartLocalData,
                options: { responsive: true, maintainAspectRatio: false, plugins: {
                    title: { display: true, text: 'Visão por Local', font: { size: 16 } },
                    legend: { display: false },
                    datalabels: {
                        anchor: 'end', align: 'top',
                        formatter: (value) => numberFormatter.format(value),
                        font: { weight: 'bold', size: 10 }
                    }
                }}
            });
            
            // --- Cria Gráfico 3: Mês (Barra) ---
            chartMes = new Chart(document.getElementById('chartMes'), {
                type: 'bar', data: initialData.chartMesData,
                options: { responsive: true, maintainAspectRatio: false, plugins: {
                    title: { display: true, text: 'Visão por Mês', font: { size: 16 } },
                    legend: { display: false },
                    datalabels: {
                        anchor: 'end', align: 'top',
                        formatter: (value) => numberFormatter.format(value),
                        font: { weight: 'bold', size: 10 }
                    }
                }}
            });

            // --- Cria Gráfico 4: Observações (Barra Horizontal) ---
            chartObservacoes = new Chart(document.getElementById('chartObservacoes'), {
                type: 'bar', data: initialData.chartObservacoesData,
                options: { responsive: true, maintainAspectRatio: false, indexAxis: 'y', 
                    plugins: {
                    title: { display: true, text: 'Visão por Observações (Total)', font: { size: 16 } },
                    legend: { display: false },
                    datalabels: {
                        anchor: 'end', align: 'right',
                        formatter: (value) => numberFormatter.format(value),
                        font: { weight: 'bold', size: 10 }
                    }
                }}
            });
            
            // --- Cria Gráfico 5: Mês vs Empresa (Empilhado) ---
            chartMesStacked = new Chart(document.getElementById('chartMesStacked'), {
                type: 'bar', data: initialData.chartMesStackedData,
                options: { responsive: true, maintainAspectRatio: false, plugins: {
                    title: { display: true, text: 'Mês (Empilhado por Empresa)', font: { size: 16 } },
                    legend: { position: 'top' },
                    datalabels: { display: false } // Desabilitado para não poluir
                }, scales: { x: { stacked: true }, y: { stacked: true } }}
            });
            
            // --- Cria Gráfico 6: Local vs Observações (Empilhado) ---
            chartLocalStacked = new Chart(document.getElementById('chartLocalStacked'), {
                type: 'bar', data: initialData.chartLocalStackedData,
                options: { responsive: true, maintainAspectRatio: false, plugins: {
                    title: { display: true, text: 'Local (Empilhado por Observação)', font: { size: 16 } },
                    legend: { position: 'top' },
                    datalabels: {
                        color: '#fff',
                        formatter: (value) => (value < 50000) ? '' : compactFormatter.format(value),
                        font: { weight: 'bold', size: 9 }
                    }
                }, scales: { x: { stacked: true }, y: { stacked: true } }}
            });
            
            // --- *** MUDANÇA (v12): Cria Gráfico 7 (Comparativo) *** ---
            chartObservacoesComparativo = new Chart(document.getElementById('chartObservacoesComparativo'), {
                type: 'bar', data: initialData.chartObservacoesComparativoData,
                options: { responsive: true, maintainAspectRatio: false, indexAxis: 'y', // Horizontal
                    plugins: {
                    title: { display: true, text: 'Observações (Comparativo por Mês)', font: { size: 16 } },
                    legend: { position: 'top' },
                    datalabels: {
                        anchor: 'end',
                        align: 'right',
                        formatter: (value) => (value > 0) ? compactFormatter.format(value) : '', // Formato compacto
                        font: { weight: 'bold', size: 9 }
                    }
                }, 
                // *** Garante que não está empilhado ***
                scales: { x: { stacked: false }, y: { stacked: false } }}
            });
            
            
            // --- Cria KPIs e Tabela Iniciais ---
            updateKPIs(initialData.totalValor, initialData.aggEmpresa);
            updateTable(initialData.aggLocalObservacoes, initialData.labelsObservacoes, initialData.labelsLocais);
        }
        
        // Inicia tudo!
        init();
    </script>


</body></html>